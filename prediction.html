<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>ML Prediction - PLA Sorties Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="7-day machine learning predictions for PLA aircraft sorties using ensemble models. Historical accuracy analysis and prediction error tracking.">
    <meta name="keywords" content="PLA prediction, machine learning, aircraft sorties forecast, Taiwan Strait, military AI, ensemble model">
    <meta name="author" content="Jeremy Chen">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://s0914712.github.io/pla-data-dashboard/prediction.html">

    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://s0914712.github.io/pla-data-dashboard/prediction.html">
    <meta property="og:title" content="ML Prediction - PLA Sorties Dashboard">
    <meta property="og:description" content="7-day machine learning predictions for PLA aircraft sorties using ensemble models.">
    <meta property="og:image" content="https://s0914712.github.io/pla-data-dashboard/images/og-image.png">
    <meta property="og:locale" content="zh_TW">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="ML Prediction - PLA Sorties Dashboard">
    <meta name="twitter:description" content="7-day machine learning predictions for PLA aircraft sorties using ensemble models.">

    <!-- Theme -->
    <meta name="theme-color" content="#f5576c">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Structured Data -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebPage",
        "name": "ML Prediction - PLA Sorties Dashboard",
        "description": "7-day machine learning predictions for PLA aircraft sorties",
        "url": "https://s0914712.github.io/pla-data-dashboard/prediction.html",
        "isPartOf": {
            "@type": "WebSite",
            "name": "PLA Dashboard",
            "url": "https://s0914712.github.io/pla-data-dashboard/"
        }
    }
    </script>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'GA_MEASUREMENT_ID');
    </script>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .navbar-custom .navbar-brand,
        .navbar-custom .nav-link {
            color: white !important;
        }

        .navbar-custom .nav-link:hover {
            color: #ddd !important;
        }

        .page-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .card-custom {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .risk-low {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .risk-medium {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: white;
        }

        .risk-high {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .prediction-card {
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: transform 0.3s;
        }

        .prediction-card:hover {
            transform: translateY(-3px);
        }

        .prediction-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .prediction-range {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .update-info {
            background: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        table thead {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .badge-risk-low {
            background-color: #28a745;
        }

        .badge-risk-medium {
            background-color: #ffc107;
            color: #333;
        }

        .badge-risk-high {
            background-color: #dc3545;
        }

        .accuracy-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }

        .accuracy-value {
            font-size: 2rem;
            font-weight: bold;
            color: #f5576c;
        }

        .accuracy-label {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .error-positive {
            color: #dc3545;
        }

        .error-negative {
            color: #28a745;
        }

        .error-zero {
            color: #6c757d;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
        }

        .nav-tabs .nav-link {
            color: #f5576c;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* ========== Mobile Optimizations ========== */

        /* Navigation - Fix hamburger menu icon visibility */
        .navbar-toggler {
            border: 2px solid rgba(255,255,255,0.5);
            padding: 0.5rem 0.75rem;
            min-height: 44px;
            min-width: 44px;
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        .navbar-toggler:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        @media (max-width: 767.98px) {
            /* Header adjustments */
            .page-header {
                padding: 1.25rem 0;
                margin-bottom: 1rem;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            .page-header .lead {
                font-size: 0.85rem;
            }

            /* Navigation dropdown */
            .navbar-collapse {
                background: rgba(102, 126, 234, 0.98);
                margin: 0.5rem -15px 0;
                padding: 0.5rem 15px;
                border-radius: 8px;
            }

            .navbar-nav .nav-link {
                padding: 0.75rem 1rem !important;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            .navbar-nav .nav-item:last-child .nav-link {
                border-bottom: none;
            }

            /* Stat cards */
            .prediction-card {
                padding: 1rem;
            }

            .prediction-value {
                font-size: 1.75rem;
            }

            .prediction-range {
                font-size: 0.8rem;
            }

            .accuracy-card {
                padding: 1rem;
            }

            .accuracy-value {
                font-size: 1.5rem;
            }

            /* Chart container adjustments */
            .card-custom {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .chart-container canvas,
            .tab-content canvas {
                max-height: 250px !important;
            }

            .tab-content {
                padding: 1rem;
            }

            .tab-content h5 {
                font-size: 0.9rem;
            }

            /* Tabs: make tappable */
            .nav-tabs .nav-link {
                font-size: 0.8rem;
                padding: 0.6rem 0.75rem;
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            /* Update info */
            .update-info {
                font-size: 0.75rem;
                padding: 0.75rem;
            }

            /* Table font size */
            .table-sm th,
            .table-sm td {
                font-size: 0.75rem;
                padding: 0.3rem 0.4rem;
            }

            /* Footer */
            footer {
                padding: 1.5rem 0 !important;
            }

            footer p {
                font-size: 0.85rem;
            }
        }

        /* Small phones */
        @media (max-width: 375px) {
            .page-header h1 {
                font-size: 1.25rem;
            }

            .prediction-value {
                font-size: 1.5rem;
            }

            .container {
                padding-left: 12px;
                padding-right: 12px;
            }

            .nav-tabs .nav-link {
                font-size: 0.7rem;
                padding: 0.5rem 0.5rem;
            }
        }

        /* Landscape phone */
        @media (max-width: 767.98px) and (orientation: landscape) {
            .page-header {
                padding: 0.75rem 0;
            }

            .chart-container canvas,
            .tab-content canvas {
                max-height: 200px !important;
            }
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="index.html">PLA Dashboard</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item active"><a class="nav-link" href="prediction.html">ML Prediction</a></li>
                <li class="nav-item"><a class="nav-link" href="weather.html">Airport Weather</a></li>
                <li class="nav-item"><a class="nav-link" href="japan.html">Japan MOD</a></li>
                <li class="nav-item"><a class="nav-link" href="news.html">News</a></li>
                <li class="nav-item"><a class="nav-link" href="download.html">Download</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1>ML Prediction Agent</h1>
        <p class="lead">Machine Learning predictions for PLA aircraft sorties (7-day forecast)</p>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <!-- Update Info -->
    <div class="update-info mb-4">
        <strong>Model:</strong> <span id="modelVersion">-</span> |
        <strong>Data Latest:</strong> <span id="dataLatest">-</span> |
        <strong>Generated:</strong> <span id="generatedAt">-</span>
    </div>

    <!-- Stale Data Warning (shown dynamically) -->
    <div id="staleWarning" class="alert alert-warning mb-4" style="display: none;">
        <strong>Data Delay:</strong> <span id="staleWarningText"></span>
    </div>

    <!-- Prediction Cards -->
    <div class="row" id="predictionCards">
        <!-- Cards will be generated by JavaScript -->
    </div>

    <!-- Prediction Accuracy Section -->
    <div class="card-custom" id="accuracySection" style="display: none;">
        <h5>Model Accuracy Statistics (預測準確度統計)</h5>
        <div class="row mt-3">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">Historical Predictions</div>
                    <div class="accuracy-value" id="totalPredictions">-</div>
                    <div class="accuracy-label">with actual data</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">MAE (平均絕對誤差)</div>
                    <div class="accuracy-value" id="maeValue">-</div>
                    <div class="accuracy-label">架次 / sorties</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">RMSE (均方根誤差)</div>
                    <div class="accuracy-value" id="rmseValue">-</div>
                    <div class="accuracy-label">架次 / sorties</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">Direction Accuracy</div>
                    <div class="accuracy-value" id="directionAccuracy">-</div>
                    <div class="accuracy-label">高/低判斷正確率</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts with Tabs -->
    <div class="card-custom">
        <ul class="nav nav-tabs" id="chartTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="forecast-tab" data-toggle="tab" href="#forecastPane" role="tab">7-Day Forecast</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="accuracy-tab" data-toggle="tab" href="#accuracyPane" role="tab">Predicted vs Actual</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="error-tab" data-toggle="tab" href="#errorPane" role="tab">Prediction Error</a>
            </li>
        </ul>
        <div class="tab-content" id="chartTabContent">
            <div class="tab-pane fade show active" id="forecastPane" role="tabpanel">
                <h5 class="mt-3">Historical Sorties (60 Days) + 7-Day Forecast (近60天實際值 + 7天預測)</h5>
                <canvas id="forecastChart"></canvas>
            </div>
            <div class="tab-pane fade" id="accuracyPane" role="tabpanel">
                <h5 class="mt-3">Predicted vs Actual Values (歷史預測 vs 實際值)</h5>
                <div id="accuracyNoData" style="display:none; text-align:center; padding:2rem; color:#666;">
                    <p>No historical prediction data with actual values available yet.</p>
                    <p>Data will appear once predictions have been made and actual values are recorded.</p>
                </div>
                <canvas id="accuracyChart"></canvas>
            </div>
            <div class="tab-pane fade" id="errorPane" role="tabpanel">
                <h5 class="mt-3">Prediction Error Over Time (預測誤差趨勢)</h5>
                <div id="errorNoData" style="display:none; text-align:center; padding:2rem; color:#666;">
                    <p>No historical prediction error data available yet.</p>
                    <p>Data will appear once predictions have been made and actual values are recorded.</p>
                </div>
                <canvas id="errorChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card-custom">
        <h5>Prediction History (預測歷史記錄)</h5>
        <p class="text-muted">Showing all predictions with actual values when available</p>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-striped table-hover table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Predicted</th>
                        <th>Actual</th>
                        <th>Error</th>
                        <th>95% CI</th>
                        <th>High Prob.</th>
                        <th>Risk</th>
                    </tr>
                </thead>
                <tbody id="predictionTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Model Information -->
    <div class="card-custom">
        <h5>About the Prediction Model</h5>
        <div class="row">
            <div class="col-md-6">
                <h6>Ensemble Model (v2.0)</h6>
                <ul>
                    <li>Combines normal activity and high-activity models</li>
                    <li>Uses political signals (3-day and 7-day windows)</li>
                    <li>Incorporates day-of-week patterns</li>
                    <li>Provides confidence intervals</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Risk Level Definitions</h6>
                <ul>
                    <li><span class="badge badge-risk-low">LOW</span> - Normal activity expected</li>
                    <li><span class="badge badge-risk-medium">MEDIUM</span> - Elevated activity possible</li>
                    <li><span class="badge badge-risk-high">HIGH</span> - High activity likely</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="text-center py-4 mt-5" style="background-color: #343a40; color: white;">
    <div class="container">
        <p>PLA Military Data Analysis Dashboard</p>
        <p>
            <a href="https://github.com/s0914712" target="_blank" style="color: #f093fb;">GitHub</a> |
            <a href="https://s0914712.github.io" target="_blank" style="color: #f093fb;">Blog</a>
        </p>
    </div>
</footer>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let predictionData = [];
let allHistoricalData = [];
let actualSortiesData = {};  // Map: date -> sorties
let actualSortiesArray = []; // Array for chart display
let forecastChart = null;
let accuracyChart = null;
let errorChart = null;
const isMobile = window.innerWidth < 768;

window.addEventListener('load', async function() {
    await loadActualSortiesData();
    await loadPredictionData();
    await loadHistoricalPredictions();
    mergeActualWithPredictions();
    calculateAccuracyStats();
    renderPredictionCards();
    renderForecastChart();
    renderAccuracyChart();
    renderErrorChart();
    renderTable();
    showStaleDataWarning();

    // Fix: Charts in hidden Bootstrap tabs may render with zero dimensions.
    // Resize them when their tab becomes visible.
    $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
        const target = $(e.target).attr('href');
        if (target === '#accuracyPane' && accuracyChart) {
            accuracyChart.resize();
        } else if (target === '#errorPane' && errorChart) {
            errorChart.resize();
        } else if (target === '#forecastPane' && forecastChart) {
            forecastChart.resize();
        }
    });
});

async function loadActualSortiesData() {
    try {
        const response = await fetch('data/JapanandBattleship.csv');
        const text = await response.text();
        const cleanText = text.replace(/^\uFEFF/, '');

        const parsed = Papa.parse(cleanText, {
            header: true,
            skipEmptyLines: true
        });

        // Build a map of date -> sorties for quick lookup
        const tempArray = parsed.data
            .filter(row => row.date && row.pla_aircraft_sorties && !isNaN(parseFloat(row.pla_aircraft_sorties)))
            .map(row => ({
                date: row.date.replace(/\//g, '-'),
                sorties: parseFloat(row.pla_aircraft_sorties)
            }))
            .sort((a, b) => new Date(a.date) - new Date(b.date));

        // Create lookup map
        tempArray.forEach(row => {
            actualSortiesData[row.date] = row.sorties;
        });

        // Get last 60 days for chart
        actualSortiesArray = tempArray.slice(-60);

        console.log('Loaded actual sorties:', Object.keys(actualSortiesData).length, 'records');
    } catch (error) {
        console.error('Error loading actual sorties data:', error);
    }
}

async function loadPredictionData() {
    try {
        // Load from new location: data/predictions/latest_prediction.csv
        const response = await fetch('data/predictions/latest_prediction.csv');
        const text = await response.text();
        const cleanText = text.replace(/^\uFEFF/, '');

        const parsed = Papa.parse(cleanText, {
            header: true,
            skipEmptyLines: true
        });

        // Get the 7-day forecast
        predictionData = parsed.data.filter(row => row.date && row.predicted_sorties);

        // Sort ascending for display
        predictionData.sort((a, b) => new Date(a.date) - new Date(b.date));

        if (predictionData.length > 0) {
            const latest = predictionData[predictionData.length - 1];
            document.getElementById('modelVersion').textContent = latest.model_version || '-';
            document.getElementById('dataLatest').textContent = latest.data_latest_date || '-';
            document.getElementById('generatedAt').textContent = latest.generated_at || '-';
        }

        console.log('Loaded latest predictions:', predictionData.length, 'records');
    } catch (error) {
        console.error('Error loading prediction data:', error);
    }
}

async function loadHistoricalPredictions() {
    try {
        // Try to load historical prediction files
        const historyFiles = [];
        const today = new Date();

        // Try to load the last 30 days of predictions
        for (let i = 1; i <= 30; i++) {
            const date = new Date(today);
            date.setDate(date.getDate() - i);
            // Use local date to avoid timezone shift (toISOString uses UTC which shifts dates for UTC+ timezones)
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;
            historyFiles.push(`data/predictions/history/prediction_${dateStr}.csv`);
        }

        const loadPromises = historyFiles.map(async (file) => {
            try {
                const response = await fetch(file);
                if (!response.ok) return [];
                const text = await response.text();
                const cleanText = text.replace(/^\uFEFF/, '');
                const parsed = Papa.parse(cleanText, { header: true, skipEmptyLines: true });
                return parsed.data;
            } catch {
                return [];
            }
        });

        const results = await Promise.all(loadPromises);

        // Flatten and deduplicate by date (keep earliest prediction for each date)
        const predictionMap = new Map();

        results.flat().forEach(row => {
            if (row.date && row.predicted_sorties) {
                // Only keep predictions for dates that have passed (we can compare with actual)
                const predDate = new Date(row.date);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                if (predDate < today) {
                    // Keep the earliest prediction made for this date
                    if (!predictionMap.has(row.date)) {
                        predictionMap.set(row.date, row);
                    }
                }
            }
        });

        allHistoricalData = Array.from(predictionMap.values());

        // Sort by date descending
        allHistoricalData.sort((a, b) => new Date(b.date) - new Date(a.date));

        console.log('Loaded historical predictions:', allHistoricalData.length, 'records');
    } catch (error) {
        console.error('Error loading historical predictions:', error);
    }
}

function mergeActualWithPredictions() {
    // Merge actual values into historical predictions
    allHistoricalData = allHistoricalData.map(row => {
        const actualValue = actualSortiesData[row.date];
        if (actualValue !== undefined) {
            const predicted = parseFloat(row.predicted_sorties);
            const error = actualValue - predicted;
            return {
                ...row,
                actual_sorties: actualValue,
                prediction_error: error
            };
        }
        return row;
    });

    // Also update current predictions with actual values if available
    predictionData = predictionData.map(row => {
        const actualValue = actualSortiesData[row.date];
        if (actualValue !== undefined) {
            const predicted = parseFloat(row.predicted_sorties);
            const error = actualValue - predicted;
            return {
                ...row,
                actual_sorties: actualValue,
                prediction_error: error
            };
        }
        return row;
    });

    console.log('Merged actual values with predictions');
}

function calculateAccuracyStats() {
    // Filter records with actual values (actual_sorties can be number or string)
    const withActual = allHistoricalData.filter(row => {
        const actual = row.actual_sorties;
        return actual !== undefined && actual !== null && actual !== '' && !isNaN(parseFloat(actual));
    });

    if (withActual.length === 0) {
        document.getElementById('accuracySection').style.display = 'none';
        return;
    }

    document.getElementById('accuracySection').style.display = 'block';
    document.getElementById('totalPredictions').textContent = withActual.length;

    // Calculate errors
    let sumAbsError = 0;
    let sumSquaredError = 0;
    let correctDirection = 0;
    let totalComparisons = 0;

    withActual.forEach(row =
