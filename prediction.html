<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>ML Prediction - PLA Sorties Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Machine Learning predictions for PLA aircraft sorties">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .navbar-custom .navbar-brand,
        .navbar-custom .nav-link {
            color: white !important;
        }

        .navbar-custom .nav-link:hover {
            color: #ddd !important;
        }

        .page-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .card-custom {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .risk-low {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .risk-medium {
            background: linear-gradient(135deg, #f7971e 0%, #ffd200 100%);
            color: white;
        }

        .risk-high {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
            color: white;
        }

        .prediction-card {
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: transform 0.3s;
        }

        .prediction-card:hover {
            transform: translateY(-3px);
        }

        .prediction-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .prediction-range {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .update-info {
            background: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
        }

        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }

        table thead {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .badge-risk-low {
            background-color: #28a745;
        }

        .badge-risk-medium {
            background-color: #ffc107;
            color: #333;
        }

        .badge-risk-high {
            background-color: #dc3545;
        }

        .accuracy-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: 100%;
        }

        .accuracy-value {
            font-size: 2rem;
            font-weight: bold;
            color: #f5576c;
        }

        .accuracy-label {
            font-size: 0.85rem;
            color: #6c757d;
        }

        .error-positive {
            color: #dc3545;
        }

        .error-negative {
            color: #28a745;
        }

        .error-zero {
            color: #6c757d;
        }

        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
        }

        .nav-tabs .nav-link {
            color: #f5576c;
        }

        .tab-content {
            background: white;
            border-radius: 0 0 10px 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="index.html">PLA Dashboard</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item active"><a class="nav-link" href="prediction.html">ML Prediction</a></li>
                <li class="nav-item"><a class="nav-link" href="weather.html">Airport Weather</a></li>
                <li class="nav-item"><a class="nav-link" href="japan.html">Japan MOD</a></li>
                <li class="nav-item"><a class="nav-link" href="news.html">News</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1>ML Prediction Agent</h1>
        <p class="lead">Machine Learning predictions for PLA aircraft sorties (7-day forecast)</p>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <!-- Update Info -->
    <div class="update-info mb-4">
        <strong>Model:</strong> <span id="modelVersion">-</span> |
        <strong>Data Latest:</strong> <span id="dataLatest">-</span> |
        <strong>Generated:</strong> <span id="generatedAt">-</span>
    </div>

    <!-- Prediction Cards -->
    <div class="row" id="predictionCards">
        <!-- Cards will be generated by JavaScript -->
    </div>

    <!-- Prediction Accuracy Section -->
    <div class="card-custom" id="accuracySection" style="display: none;">
        <h5>Model Accuracy Statistics (預測準確度統計)</h5>
        <div class="row mt-3">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">Historical Predictions</div>
                    <div class="accuracy-value" id="totalPredictions">-</div>
                    <div class="accuracy-label">with actual data</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">MAE (平均絕對誤差)</div>
                    <div class="accuracy-value" id="maeValue">-</div>
                    <div class="accuracy-label">架次 / sorties</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">RMSE (均方根誤差)</div>
                    <div class="accuracy-value" id="rmseValue">-</div>
                    <div class="accuracy-label">架次 / sorties</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="accuracy-card">
                    <div class="accuracy-label">Direction Accuracy</div>
                    <div class="accuracy-value" id="directionAccuracy">-</div>
                    <div class="accuracy-label">高/低判斷正確率</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts with Tabs -->
    <div class="card-custom">
        <ul class="nav nav-tabs" id="chartTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="forecast-tab" data-toggle="tab" href="#forecastPane" role="tab">7-Day Forecast</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="accuracy-tab" data-toggle="tab" href="#accuracyPane" role="tab">Predicted vs Actual</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="error-tab" data-toggle="tab" href="#errorPane" role="tab">Prediction Error</a>
            </li>
        </ul>
        <div class="tab-content" id="chartTabContent">
            <div class="tab-pane fade show active" id="forecastPane" role="tabpanel">
                <h5 class="mt-3">7-Day Forecast Trend</h5>
                <canvas id="forecastChart"></canvas>
            </div>
            <div class="tab-pane fade" id="accuracyPane" role="tabpanel">
                <h5 class="mt-3">Predicted vs Actual Values (歷史預測 vs 實際值)</h5>
                <canvas id="accuracyChart"></canvas>
            </div>
            <div class="tab-pane fade" id="errorPane" role="tabpanel">
                <h5 class="mt-3">Prediction Error Over Time (預測誤差趨勢)</h5>
                <canvas id="errorChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card-custom">
        <h5>Prediction History (預測歷史記錄)</h5>
        <p class="text-muted">Showing all predictions with actual values when available</p>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-striped table-hover table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Day</th>
                        <th>Predicted</th>
                        <th>Actual</th>
                        <th>Error</th>
                        <th>95% CI</th>
                        <th>High Prob.</th>
                        <th>Risk</th>
                    </tr>
                </thead>
                <tbody id="predictionTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Model Information -->
    <div class="card-custom">
        <h5>About the Prediction Model</h5>
        <div class="row">
            <div class="col-md-6">
                <h6>Ensemble Model (v2.0)</h6>
                <ul>
                    <li>Combines normal activity and high-activity models</li>
                    <li>Uses political signals (3-day and 7-day windows)</li>
                    <li>Incorporates day-of-week patterns</li>
                    <li>Provides confidence intervals</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Risk Level Definitions</h6>
                <ul>
                    <li><span class="badge badge-risk-low">LOW</span> - Normal activity expected</li>
                    <li><span class="badge badge-risk-medium">MEDIUM</span> - Elevated activity possible</li>
                    <li><span class="badge badge-risk-high">HIGH</span> - High activity likely</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="text-center py-4 mt-5" style="background-color: #343a40; color: white;">
    <div class="container">
        <p>PLA Military Data Analysis Dashboard</p>
        <p>
            <a href="https://github.com/s0914712" target="_blank" style="color: #f093fb;">GitHub</a> |
            <a href="https://s0914712.github.io" target="_blank" style="color: #f093fb;">Blog</a>
        </p>
    </div>
</footer>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let predictionData = [];
let allHistoricalData = [];
let forecastChart = null;
let accuracyChart = null;
let errorChart = null;

window.addEventListener('load', async function() {
    await loadPredictionData();
    calculateAccuracyStats();
    renderPredictionCards();
    renderForecastChart();
    renderAccuracyChart();
    renderErrorChart();
    renderTable();
});

async function loadPredictionData() {
    try {
        const response = await fetch('data/prediction.csv');
        const text = await response.text();
        const cleanText = text.replace(/^\uFEFF/, '');

        const parsed = Papa.parse(cleanText, {
            header: true,
            skipEmptyLines: true
        });

        allHistoricalData = parsed.data;

        // Sort by date descending
        allHistoricalData.sort((a, b) => new Date(b.date) - new Date(a.date));

        // Get latest 7 predictions for the forecast view
        const today = new Date();
        predictionData = allHistoricalData.filter(row => {
            const rowDate = new Date(row.date);
            return rowDate >= today || allHistoricalData.indexOf(row) < 7;
        }).slice(0, 7);

        // Sort ascending for display
        predictionData.sort((a, b) => new Date(a.date) - new Date(b.date));

        if (allHistoricalData.length > 0) {
            const latest = allHistoricalData[0];
            document.getElementById('modelVersion').textContent = latest.model_version || '-';
            document.getElementById('dataLatest').textContent = latest.data_latest_date || '-';
            document.getElementById('generatedAt').textContent = latest.generated_at || '-';
        }
    } catch (error) {
        console.error('Error loading prediction data:', error);
    }
}

function calculateAccuracyStats() {
    // Filter records with actual values
    const withActual = allHistoricalData.filter(row =>
        row.actual_sorties && row.actual_sorties !== '' && !isNaN(parseFloat(row.actual_sorties))
    );

    if (withActual.length === 0) {
        document.getElementById('accuracySection').style.display = 'none';
        return;
    }

    document.getElementById('accuracySection').style.display = 'block';
    document.getElementById('totalPredictions').textContent = withActual.length;

    // Calculate errors
    let sumAbsError = 0;
    let sumSquaredError = 0;
    let correctDirection = 0;
    let totalComparisons = 0;

    withActual.forEach(row => {
        const predicted = parseFloat(row.predicted_sorties);
        const actual = parseFloat(row.actual_sorties);

        if (!isNaN(predicted) && !isNaN(actual)) {
            const error = actual - predicted;
            sumAbsError += Math.abs(error);
            sumSquaredError += error * error;

            // Direction accuracy (using 30 as threshold)
            const predHigh = predicted >= 30;
            const actualHigh = actual >= 30;
            if (predHigh === actualHigh) correctDirection++;
            totalComparisons++;
        }
    });

    const mae = sumAbsError / withActual.length;
    const rmse = Math.sqrt(sumSquaredError / withActual.length);
    const directionAcc = (correctDirection / totalComparisons * 100);

    document.getElementById('maeValue').textContent = mae.toFixed(1);
    document.getElementById('rmseValue').textContent = rmse.toFixed(1);
    document.getElementById('directionAccuracy').textContent = directionAcc.toFixed(0) + '%';
}

function getRiskClass(level) {
    switch(level?.toUpperCase()) {
        case 'LOW': return 'risk-low';
        case 'MEDIUM': return 'risk-medium';
        case 'HIGH': return 'risk-high';
        default: return 'risk-low';
    }
}

function getRiskBadgeClass(level) {
    switch(level?.toUpperCase()) {
        case 'LOW': return 'badge-risk-low';
        case 'MEDIUM': return 'badge-risk-medium';
        case 'HIGH': return 'badge-risk-high';
        default: return 'badge-risk-low';
    }
}

function renderPredictionCards() {
    const container = document.getElementById('predictionCards');
    container.innerHTML = '';

    predictionData.forEach((row, index) => {
        const riskClass = getRiskClass(row.risk_level);
        const predicted = parseFloat(row.predicted_sorties).toFixed(1);
        const lower = parseFloat(row.lower_bound).toFixed(1);
        const upper = parseFloat(row.upper_bound).toFixed(1);
        const highProb = parseFloat(row.high_event_probability).toFixed(1);

        const date = new Date(row.date);
        const dateStr = date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });

        // Check if actual value exists
        const hasActual = row.actual_sorties && row.actual_sorties !== '' && !isNaN(parseFloat(row.actual_sorties));
        const actualVal = hasActual ? parseFloat(row.actual_sorties).toFixed(0) : null;
        const errorVal = hasActual ? (parseFloat(row.actual_sorties) - parseFloat(row.predicted_sorties)).toFixed(1) : null;

        const cardHtml = `
            <div class="col-md-3 col-sm-6">
                <div class="prediction-card ${riskClass}">
                    <div class="text-center">
                        <div style="font-size: 0.9rem; opacity: 0.9;">${dateStr} (${row.day_of_week})</div>
                        <div class="prediction-value">${predicted}</div>
                        <div class="prediction-range">Range: ${lower} - ${upper}</div>
                        ${hasActual ? `
                            <div style="margin-top: 0.5rem; background: rgba(255,255,255,0.2); padding: 0.3rem; border-radius: 5px;">
                                <small>Actual: <strong>${actualVal}</strong> (${errorVal >= 0 ? '+' : ''}${errorVal})</small>
                            </div>
                        ` : `
                            <div style="margin-top: 0.5rem;">
                                <small>High Event: ${highProb}%</small>
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;
    });
}

function renderForecastChart() {
    const ctx = document.getElementById('forecastChart').getContext('2d');

    const labels = predictionData.map(r => {
        const date = new Date(r.date);
        return date.toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' });
    });

    const predicted = predictionData.map(r => parseFloat(r.predicted_sorties));
    const lower = predictionData.map(r => parseFloat(r.lower_bound));
    const upper = predictionData.map(r => parseFloat(r.upper_bound));
    const actual = predictionData.map(r => {
        return r.actual_sorties && r.actual_sorties !== '' ? parseFloat(r.actual_sorties) : null;
    });

    forecastChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Predicted Sorties',
                    data: predicted,
                    borderColor: '#f5576c',
                    backgroundColor: 'rgba(245, 87, 108, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4
                },
                {
                    label: 'Actual Sorties',
                    data: actual,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 3,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 6,
                    pointBackgroundColor: '#28a745'
                },
                {
                    label: 'Upper Bound (95% CI)',
                    data: upper,
                    borderColor: 'rgba(245, 87, 108, 0.3)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: false,
                    pointRadius: 0
                },
                {
                    label: 'Lower Bound (95% CI)',
                    data: lower,
                    borderColor: 'rgba(245, 87, 108, 0.3)',
                    borderWidth: 1,
                    borderDash: [5, 5],
                    fill: '-1',
                    backgroundColor: 'rgba(245, 87, 108, 0.1)',
                    pointRadius: 0
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Aircraft Sorties' }
                }
            }
        }
    });
}

function renderAccuracyChart() {
    const ctx = document.getElementById('accuracyChart').getContext('2d');

    // Get last 60 days with actual values
    const withActual = allHistoricalData
        .filter(r => r.actual_sorties && r.actual_sorties !== '' && !isNaN(parseFloat(r.actual_sorties)))
        .slice(0, 60)
        .reverse();

    if (withActual.length === 0) {
        ctx.font = '16px Arial';
        ctx.fillText('No historical data with actual values available yet', 50, 100);
        return;
    }

    const labels = withActual.map(r => {
        const date = new Date(r.date);
        return date.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });
    });

    const predicted = withActual.map(r => parseFloat(r.predicted_sorties));
    const actual = withActual.map(r => parseFloat(r.actual_sorties));

    accuracyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Predicted',
                    data: predicted,
                    borderColor: '#f5576c',
                    backgroundColor: 'rgba(245, 87, 108, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3
                },
                {
                    label: 'Actual',
                    data: actual,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: { mode: 'index', intersect: false }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Aircraft Sorties' }
                }
            }
        }
    });
}

function renderErrorChart() {
    const ctx = document.getElementById('errorChart').getContext('2d');

    // Get last 60 days with actual values
    const withActual = allHistoricalData
        .filter(r => r.prediction_error && r.prediction_error !== '' && !isNaN(parseFloat(r.prediction_error)))
        .slice(0, 60)
        .reverse();

    if (withActual.length === 0) {
        ctx.font = '16px Arial';
        ctx.fillText('No historical error data available yet', 50, 100);
        return;
    }

    const labels = withActual.map(r => {
        const date = new Date(r.date);
        return date.toLocaleDateString('zh-TW', { month: 'numeric', day: 'numeric' });
    });

    const errors = withActual.map(r => parseFloat(r.prediction_error));
    const colors = errors.map(e => e > 0 ? 'rgba(220, 53, 69, 0.7)' : 'rgba(40, 167, 69, 0.7)');

    errorChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Prediction Error (Actual - Predicted)',
                data: errors,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.7', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            return `Error: ${value > 0 ? '+' : ''}${value.toFixed(1)} (${value > 0 ? 'Underestimated' : 'Overestimated'})`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    title: { display: true, text: 'Error (Actual - Predicted)' }
                }
            }
        }
    });
}

function renderTable() {
    const tbody = document.getElementById('predictionTableBody');
    tbody.innerHTML = '';

    // Show all historical data sorted by date descending
    const sortedData = [...allHistoricalData].sort((a, b) => new Date(b.date) - new Date(a.date));

    sortedData.forEach(row => {
        const badgeClass = getRiskBadgeClass(row.risk_level);
        const hasActual = row.actual_sorties && row.actual_sorties !== '' && !isNaN(parseFloat(row.actual_sorties));
        const actualVal = hasActual ? parseFloat(row.actual_sorties).toFixed(0) : '-';

        let errorHtml = '-';
        if (row.prediction_error && row.prediction_error !== '' && !isNaN(parseFloat(row.prediction_error))) {
            const err = parseFloat(row.prediction_error);
            const errorClass = err > 0 ? 'error-positive' : (err < 0 ? 'error-negative' : 'error-zero');
            errorHtml = `<span class="${errorClass}">${err > 0 ? '+' : ''}${err.toFixed(1)}</span>`;
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.date}</td>
            <td>${row.day_of_week || '-'}</td>
            <td><strong>${parseFloat(row.predicted_sorties).toFixed(1)}</strong></td>
            <td>${actualVal}</td>
            <td>${errorHtml}</td>
            <td>${parseFloat(row.lower_bound).toFixed(0)} - ${parseFloat(row.upper_bound).toFixed(0)}</td>
            <td>${parseFloat(row.high_event_probability).toFixed(1)}%</td>
            <td><span class="badge ${badgeClass}">${row.risk_level}</span></td>
        `;
        tbody.appendChild(tr);
    });
}
</script>

</body>
</html>
