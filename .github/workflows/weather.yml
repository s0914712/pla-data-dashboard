name: Weather Report

on:
  # å®šæ™‚åŸ·è¡Œ - æ¯å¤© UTC 00:30 å’Œ 12:30ï¼ˆå°ç£æ™‚é–“ 08:30 / 20:30ï¼‰
  schedule:
    - cron: '30 0,12 * * *'

  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

  # Push åˆ° main æ™‚åŸ·è¡Œï¼ˆscraper æˆ– workflow è®Šæ›´æ™‚ï¼‰
  push:
    branches:
      - main
    paths:
      - 'scripts/scrapers/weather_scraper.py'
      - '.github/workflows/weather.yml'

jobs:
  fetch-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas

      - name: Run weather scraper
        env:
          WINDY_API_KEY: ${{ secrets.WINDY_API_KEY }}
        run: python scripts/scrapers/weather_scraper.py

      # ï¼ˆåªåœ¨ä½ è¦ debug æ™‚æ‰“é–‹ï¼‰
      # - name: Debug output files
      #   run: ls -R

      - name: Commit and push CSV results
        run: |
          set -e

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          # è‹¥ data è³‡æ–™å¤¾ä¸å­˜åœ¨æˆ–æ²’æœ‰ CSVï¼Œå‰‡è·³é
          if [ -d data ] && ls data/*.csv >/dev/null 2>&1; then
            git add data/*.csv
            if ! git diff --staged --quiet; then
              git commit -m "ğŸ“Š Update airport weather data - $(date +'%Y-%m-%d %H:%M') UTC"
              # Retry push with pull --rebase to handle concurrent updates
              for i in 1 2 3 4; do
                git push && break
                echo "Push failed (attempt $i/4), pulling latest changes..."
                git pull --rebase --autostash -X theirs origin main
                sleep $((2 ** i))
              done
            fi
          else
            echo "âš ï¸ No CSV files found in data/, skipping commit"
          fi
