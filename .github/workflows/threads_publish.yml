name: Publish to Threads
on:
  # 在 Daily News Data Update 完成後自動觸發
  workflow_run:
    workflows: ["Daily News Data Update"]
    types: [completed]
  # 每天 UTC 00:30（台北 08:30），daily_update 之後 15 分鐘
  schedule:
    - cron: '30 0 * * *'
  # 手動觸發
  workflow_dispatch:
    inputs:
      dry_run:
        description: '只輸出內容不實際發布'
        required: false
        default: false
        type: boolean
jobs:
  publish-threads:
    runs-on: ubuntu-latest
    # workflow_run 觸發時，只在成功時才執行
    if: >
      github.event_name != 'workflow_run' ||
      github.event.workflow_run.conclusion == 'success'
    permissions:
      contents: write  # 推送圖片回 repo
    steps:
      # 1. 檢出代碼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      # 2. 設置 Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      # 3. 安裝依賴
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas matplotlib threads-api requests threads-api
      # 4. 安裝中文字體（CI 環境）
      - name: Install CJK fonts
        run: |
          sudo apt-get update
          sudo apt-get install -y fonts-noto-cjk
          fc-cache -fv
      # 5. 執行發布腳本
      - name: Publish to Threads
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          THREADS_USER_ID: ${{ secrets.THREADS_USER_ID }}
          THREADS_ACCESS_TOKEN: ${{ secrets.THREADS_ACCESS_TOKEN }}
          THREADS_APP_SECRET: ${{ secrets.THREADS_APP_SECRET }}
        run: |
          python scripts/publish_threads.py \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }}
      # 6. 上傳圖表 artifact（備份）
      - name: Upload chart artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: threads-chart-${{ github.run_number }}
          path: data/charts/threads_chart.png
          retention-days: 7
  # 失敗通知
  notify-on-failure:
    needs: publish-threads
    runs-on: ubuntu-latest
    if: failure()
    steps:
      - name: Send failure notification
        run: |
          echo "❌ Threads 發布失敗"
          echo "Run number: ${{ github.run_number }}"
          echo "Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
