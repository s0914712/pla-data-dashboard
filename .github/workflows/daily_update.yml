name: Daily News Data Update

on:
  schedule:
    # æ¯å¤© UTC 00:00 åŸ·è¡Œ (å°åŒ—æ™‚é–“ 08:00)
    - cron: '0 0 * * *'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      days_back:
        description: 'çˆ¬å–éå»å¹¾å¤©çš„æ–°è'
        required: false
        default: '7'
        type: string
      skip_push:
        description: 'è·³éæ¨é€åˆ° GitHub'
        required: false
        default: false
        type: boolean

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # å…è¨±æ¨é€
    
    steps:
      # 1. æª¢å‡ºä»£ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # å®Œæ•´æ­·å²
      
      # 2. è¨­ç½® Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # 3. å®‰è£ä¾è³´
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # 4. åŸ·è¡Œæ›´æ–°è…³æœ¬
      - name: Run news scraper and classifier
        env:
          SERPAPI_KEY : ${{ secrets.SERPAPI_KEY  }}
          GROK_API_KEY: ${{ secrets.GROK_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/main.py \
            --days ${{ github.event.inputs.days_back || '7' }} \
            ${{ github.event.inputs.skip_push == 'true' && '--no-push' || '' }}
      
      # 5. é¡¯ç¤ºæ›´æ–°æ‘˜è¦ï¼ˆå¯é¸ï¼‰
      - name: Show update summary
        if: always()
        run: |
          if [ -f data/last_update.json ]; then
            echo "ğŸ“Š Update Summary:"
            cat data/last_update.json
          fi
      
      # 6. æäº¤è®Šæ›´ï¼ˆåƒ…åœ¨è…³æœ¬æœªè‡ªå‹•æ¨é€æ™‚ï¼‰
      - name: Commit and push data changes
        if: ${{ github.event.inputs.skip_push != 'true' }}
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"
          
          # æ·»åŠ æ•¸æ“šæ–‡ä»¶ï¼ˆä¸åŒ…å«ç¨‹å¼ç¢¼ï¼‰
          git add data/*.csv || true
          git add data/*.json || true
          git add data/logs/*.json || true
          
          # æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
          if git diff --staged --quiet; then
            echo "âœ“ No changes to commit"
          else
            # ç²å–è®Šæ›´çµ±è¨ˆ
            git diff --staged --stat
            
            # æäº¤ä¸¦æ¨é€
            git commit -m "ğŸ¤– Auto-update data: $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ“ Changes pushed successfully"
          fi
      
      # 7. ä¸Šå‚³æ—¥èªŒä½œç‚º Artifact
      - name: Upload execution logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: update-logs-${{ github.run_number }}
          path: data/logs/
          retention-days: 30
      
      # 8. ä¸Šå‚³æ•¸æ“šæ–‡ä»¶ä½œç‚º Artifactï¼ˆç”¨æ–¼å‚™ä»½ï¼‰
      - name: Upload data files
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: data-snapshot-${{ github.run_number }}
          path: |
            data/*.csv
            data/*.json
          retention-days: 7

  # å¤±æ•—é€šçŸ¥
  notify-on-failure:
    needs: update-data
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "âŒ Daily update job failed"
          echo "Run number: ${{ github.run_number }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Check logs at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # TODO: å¯ä»¥åœ¨é€™è£¡æ·»åŠ  Slack/Discord/Email é€šçŸ¥
          # ä¾‹å¦‚ï¼š
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{"text":"âŒ PLA Data Update Failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"}'
