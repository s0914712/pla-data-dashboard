name: Scrape MSA Military Exercise Warnings

on:
  schedule:
    # æ¯å¤© UTC 02:00 (åŒ—äº¬æ™‚é–“ 10:00) åŸ·è¡Œ
    - cron: '0 2 * * *'
  
  # å…è¨±æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  
  # ä»£ç¢¼è®Šæ›´æ™‚åŸ·è¡Œ
  push:
    branches:
      - main
    paths:
      - 'scripts/scrapers/NavigationWarning_scraper.py'
      - '.github/workflows/scrape_nav_warnings.yml'

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pandas lxml httpx
    
    - name: ğŸ¯ Run Military Exercise Scraper
      run: |
        python << 'PYTHON_SCRIPT'
        import sys
        import json
        import pandas as pd
        from pathlib import Path
        from datetime import datetime
        from collections import Counter
        
        sys.path.insert(0, 'scripts')
        from scrapers.NavigationWarning_scraper import NavigationWarningScraper
        
        print('ğŸ¯ é–‹å§‹çˆ¬å–è»äº‹æ¼”ç¿’ç›¸é—œèˆªè¡Œè­¦å‘Š...')
        
        # âœ… ä¿®æ­£ï¼šä½¿ç”¨æ­£ç¢ºçš„åƒæ•¸
        with NavigationWarningScraper(delay=1.0) as scraper:
            warnings = scraper.run(
                days_back=365,    # éå»365å¤©
                max_pages=1       # æ¯å€‹æµ·äº‹å±€æŠ“1é ï¼ˆç´„20ç¯‡ï¼‰
            )
        
        # å‰µå»ºè¼¸å‡ºç›®éŒ„
        output_dir = Path('data/navigation_warnings')
        output_dir.mkdir(parents=True, exist_ok=True)

        # å¦‚æœçˆ¬å–å¤±æ•—ï¼ˆ0 çµæœï¼‰ï¼Œä¿ç•™ç¾æœ‰æ•¸æ“š
        if not warnings:
            print('âš ï¸  æœªç²å–åˆ°æ–°æ•¸æ“šï¼Œä¿ç•™ç¾æœ‰æ•¸æ“š')
            json_path = output_dir / 'military_exercises.json'
            if json_path.exists():
                with open(json_path, 'r', encoding='utf-8') as f:
                    warnings = json.load(f)
                print(f'ğŸ“‚ å·²è¼‰å…¥ç¾æœ‰æ•¸æ“š: {len(warnings)} æ¢è¨˜éŒ„')
            else:
                warnings = []

        # å®šç¾©æ¬„ä½
        columns = [
            'publish_date',       # ç™¼å¸ƒæ—¥æœŸ
            'title',              # æ¨™é¡Œ
            'channel',            # æµ·äº‹å±€
            'time_periods',       # æ¼”ç¿’æ™‚é–“ç¯„åœ
            'coordinate_count',   # ç¶“ç·¯åº¦æ•¸é‡
            'coordinates',        # ç¶“ç·¯åº¦ï¼ˆåé€²åˆ¶ï¼‰
            'coordinates_raw',    # ç¶“ç·¯åº¦ï¼ˆåŸå§‹æ ¼å¼ï¼‰
            'content_preview',    # å…§å®¹é è¦½
            'url',                # éˆæ¥
            'scraped_at'          # æŠ“å–æ™‚é–“
        ]

        # ä¿å­˜ CSV
        if warnings:
            df = pd.DataFrame(warnings)
            csv_path = output_dir / 'military_exercises.csv'
            df.to_csv(csv_path, index=False, encoding='utf-8-sig')
            print(f'ğŸ’¾ å·²ä¿å­˜: {csv_path} ({len(df)} æ¢è¨˜éŒ„)')
        else:
            csv_path = output_dir / 'military_exercises.csv'
            pd.DataFrame(columns=columns).to_csv(
                csv_path,
                index=False,
                encoding='utf-8-sig'
            )
            print(f'ğŸ’¾ å·²ä¿å­˜ç©ºæ–‡ä»¶: {csv_path}')

        # ä¿å­˜ JSON
        json_path = output_dir / 'military_exercises.json'
        with open(json_path, 'w', encoding='utf-8') as f:
            json.dump(warnings, f, ensure_ascii=False, indent=2)
        print(f'ğŸ’¾ å·²ä¿å­˜: {json_path}')
        
        # ç”Ÿæˆçµ±è¨ˆ
        if warnings:
            coords_count = sum(1 for w in warnings if w.get('coordinate_count', 0) > 0)
            time_count = sum(1 for w in warnings if w.get('time_periods'))
            
            stats = {
                'update_time': datetime.now().isoformat(),
                'total_warnings': len(warnings),
                'with_coordinates': coords_count,
                'with_time_periods': time_count,
                'date_range': {
                    'earliest': min(w['publish_date'] for w in warnings if w['publish_date']),
                    'latest': max(w['publish_date'] for w in warnings if w['publish_date'])
                },
                'by_channel': dict(Counter(w['channel'] for w in warnings))
            }
        else:
            stats = {
                'update_time': datetime.now().isoformat(),
                'total_warnings': 0,
                'with_coordinates': 0,
                'with_time_periods': 0,
                'date_range': {'earliest': None, 'latest': None},
                'by_channel': {}
            }
        
        # ä¿å­˜çµ±è¨ˆ
        stats_path = output_dir / 'statistics.json'
        with open(stats_path, 'w', encoding='utf-8') as f:
            json.dump(stats, f, ensure_ascii=False, indent=2)
        print(f'ğŸ’¾ å·²ä¿å­˜: {stats_path}')
        
        # è¼¸å‡ºæ‘˜è¦
        print(f'\nâœ… ä»»å‹™å®Œæˆï¼')
        print(f'   ç¸½è¨ˆè­¦å‘Š: {len(warnings)} æ¢')
        print(f'   å«ç¶“ç·¯åº¦: {stats["with_coordinates"]} æ¢')
        print(f'   å«æ™‚é–“ç¯„åœ: {stats["with_time_periods"]} æ¢')
        PYTHON_SCRIPT
    
    - name: ğŸ“Š Display statistics
      run: |
        if [ -f data/navigation_warnings/statistics.json ]; then
          echo "ğŸ“ˆ çµ±è¨ˆä¿¡æ¯:"
          cat data/navigation_warnings/statistics.json | python -m json.tool
        fi
    
    - name: ğŸ’¾ Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        git add data/navigation_warnings/

        if git diff --staged --quiet; then
          echo "ğŸ“­ No changes to commit"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¯ Auto-update: Military Exercise Warnings - ${TIMESTAMP}"

          # Retry push with pull --rebase to handle concurrent updates
          for i in 1 2 3 4; do
            git push && break
            echo "âš ï¸  Push failed (attempt $i/4), pulling latest changes..."
            git pull --rebase origin main
            sleep $((2 ** i))
          done
          echo "âœ… Changes committed and pushed"
        fi
    
    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: military-exercise-warnings
        path: |
          data/navigation_warnings/*.csv
          data/navigation_warnings/*.json
        retention-days: 90
