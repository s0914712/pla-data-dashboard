# .github/workflows/scrape_nav_warnings.yml
name: Scrape MSA Military Exercise Warnings

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'scripts/scrapers/NavigationWarning_scraper.py'
      - '.github/workflows/scrape_nav_warnings.yml'

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 pandas lxml httpx
    
    - name: ğŸ¯ Run Military Exercise Scraper
      run: |
        python << 'PYTHON_SCRIPT'
        import sys
        import json
        import pandas as pd
        from pathlib import Path
        from datetime import datetime
        from collections import Counter
        
        sys.path.insert(0, 'scripts')
        from scrapers.NavigationWarning_scraper import NavigationWarningScraper
        
        print('ğŸ¯ é–‹å§‹çˆ¬å–è»äº‹æ¼”ç¿’ç›¸é—œèˆªè¡Œè­¦å‘Š...')
        
        with NavigationWarningScraper(delay=1.0) as scraper:
            warnings = scraper.run(max_pages=50, days_back=365)
        
        if not warnings:
            print('âš ï¸  æœªç²å–åˆ°è»äº‹æ¼”ç¿’æ•¸æ“š')
            warnings = []
        
        # å‰µå»ºè¼¸å‡ºç›®éŒ„
        output_dir = Path('data/navigation_warnings')
        output_dir.mkdir(parents=True, exist_ok=True)
        
        # ä¿å­˜ CSV
        if warnings:
            df = pd.DataFrame(warnings)
            csv_path = output_dir / 'military_exercises.csv'
            df.to_csv(csv_path, index=False, encoding='utf-8-sig')
            print(f'ğŸ’¾ å·²ä¿å­˜: {csv_path} ({len(df)} æ¢è¨˜éŒ„)')
        else:
            csv_path = output_dir / 'military_exercises.csv'
            pd.DataFrame(columns=['date', 'title', 'msa', 'matched_keywords', 'article_id', 'url', 'scraped_at']).to_csv(csv_path, index=False, encoding='utf-8-sig')
            print(f'ğŸ’¾ å·²ä¿å­˜ç©ºæ–‡ä»¶: {csv_path}')
        
        # ä¿å­˜ JSON
        json_path = output_dir / 'military_exercises.json'
        with open(json_path, 'w', encoding='utf-8') as f:
            json.dump(warnings, f, ensure_ascii=False, indent=2)
        print(f'ğŸ’¾ å·²ä¿å­˜: {json_path}')
        
        # ç”Ÿæˆçµ±è¨ˆ
        if warnings:
            all_keywords = []
            for w in warnings:
                if w.get('matched_keywords'):
                    all_keywords.extend(w['matched_keywords'].split(','))
            
            stats = {
                'update_time': datetime.now().isoformat(),
                'total_warnings': len(warnings),
                'date_range': {
                    'earliest': min(w['date'] for w in warnings),
                    'latest': max(w['date'] for w in warnings)
                },
                'by_msa': dict(Counter(w['msa'] for w in warnings)),
                'by_keyword': dict(Counter(all_keywords).most_common(20))
            }
        else:
            stats = {
                'update_time': datetime.now().isoformat(),
                'total_warnings': 0,
                'date_range': {'earliest': None, 'latest': None},
                'by_msa': {},
                'by_keyword': {}
            }
        
        stats_path = output_dir / 'statistics.json'
        with open(stats_path, 'w', encoding='utf-8') as f:
            json.dump(stats, f, ensure_ascii=False, indent=2)
        print(f'ğŸ’¾ å·²ä¿å­˜: {stats_path}')
        
        print(f'\nâœ… ä»»å‹™å®Œæˆï¼å…± {len(warnings)} æ¢è»äº‹æ¼”ç¿’è­¦å‘Š')
        PYTHON_SCRIPT
    
    - name: ğŸ“Š Display statistics
      run: |
        if [ -f data/navigation_warnings/statistics.json ]; then
          echo "ğŸ“ˆ çµ±è¨ˆä¿¡æ¯:"
          cat data/navigation_warnings/statistics.json | python -m json.tool
        fi
    
    - name: ğŸ’¾ Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add data/navigation_warnings/
        
        if git diff --staged --quiet; then
          echo "ğŸ“­ No changes to commit"
        else
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          git commit -m "ğŸ¯ Auto-update: Military Exercise Warnings - ${TIMESTAMP}"
          git push
          echo "âœ… Changes committed and pushed"
        fi
    
    - name: ğŸ“¤ Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: military-exercise-warnings
        path: |
          data/navigation_warnings/*.csv
          data/navigation_warnings/*.json
        retention-days: 90
