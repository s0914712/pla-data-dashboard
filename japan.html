<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="utf-8">
    <title>Japan MOD - PLA Sorties Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="description" content="Japan Ministry of Defense naval transit monitoring">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }

        .navbar-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .navbar-custom .navbar-brand,
        .navbar-custom .nav-link {
            color: white !important;
        }

        .navbar-custom .nav-link:hover {
            color: #ddd !important;
        }

        .page-header {
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .card-custom {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        #map {
            height: 450px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #c94b4b;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .strait-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            margin: 0.25rem;
            font-size: 0.85rem;
        }

        .strait-yonaguni { background: #e74c3c; color: white; }
        .strait-miyako { background: #3498db; color: white; }
        .strait-osumi { background: #2ecc71; color: white; }
        .strait-tsushima { background: #9b59b6; color: white; }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        table thead {
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
            color: white;
        }

        .transit-in { color: #27ae60; font-weight: bold; }
        .transit-out { color: #e74c3c; font-weight: bold; }

        .legend {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .update-info {
            background: #e9ecef;
            border-radius: 8px;
            padding: 1rem;
            font-size: 0.85rem;
            margin-bottom: 1.5rem;
        }

        .source-link {
            color: #c94b4b;
        }

        .source-link:hover {
            color: #4b134f;
        }

        .latest-event-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #c94b4b;
        }

        .latest-event-card .event-date {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
        }

        .latest-event-card .event-strait {
            display: inline-block;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            margin-right: 0.3rem;
        }

        .latest-event-card .event-remark {
            font-size: 0.9rem;
            line-height: 1.5;
            margin-top: 0.5rem;
        }

        /* Military Warning Styles */
        .warning-type-exercise { background: #e74c3c; color: white; }
        .warning-type-livefire { background: #e67e22; color: white; }
        .warning-type-rocket { background: #8e44ad; color: white; }
        .warning-type-mission { background: #2980b9; color: white; }
        .warning-type-other { background: #7f8c8d; color: white; }

        .warning-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .msa-stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #e67e22;
        }

        .warning-card {
            background: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #e67e22;
        }

        .warning-card .warning-date {
            font-size: 0.85rem;
            color: #666;
        }

        .warning-card .warning-title {
            font-weight: 600;
            margin: 0.3rem 0;
        }

        .warning-card .warning-channel {
            font-size: 0.8rem;
            color: #888;
        }

        .event-popup {
            min-width: 280px;
            max-width: 350px;
        }

        .event-popup h6 {
            margin-bottom: 0.5rem;
            color: #c94b4b;
        }

        .event-popup .badge {
            font-size: 0.7rem;
            margin-right: 0.25rem;
        }

        .pulse-marker {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* ========== Mobile Optimizations ========== */

        /* Navigation - Fix hamburger menu icon visibility */
        .navbar-toggler {
            border: 2px solid rgba(255,255,255,0.5);
            padding: 0.5rem 0.75rem;
            min-height: 44px;
            min-width: 44px;
        }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba%28255, 255, 255, 1%29' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
        }

        .navbar-toggler:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.3);
        }

        @media (max-width: 767.98px) {
            /* Header adjustments */
            .page-header {
                padding: 1.25rem 0;
                margin-bottom: 1rem;
            }

            .page-header h1 {
                font-size: 1.5rem;
            }

            .page-header .lead {
                font-size: 0.85rem;
            }

            /* Navigation dropdown */
            .navbar-collapse {
                background: rgba(102, 126, 234, 0.98);
                margin: 0.5rem -15px 0;
                padding: 0.5rem 15px;
                border-radius: 8px;
            }

            .navbar-nav .nav-link {
                padding: 0.75rem 1rem !important;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            .navbar-nav .nav-item:last-child .nav-link {
                border-bottom: none;
            }

            /* Stat cards */
            .stat-card {
                padding: 1rem;
                margin-bottom: 0.5rem;
            }

            .stat-value {
                font-size: 1.75rem;
            }

            .msa-stat-value {
                font-size: 1.75rem;
            }

            .stat-label {
                font-size: 0.75rem;
            }

            /* Map height on mobile */
            #map {
                height: 300px !important;
            }

            /* Card and chart containers */
            .card-custom {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .chart-container {
                padding: 1rem;
                margin-bottom: 1rem;
            }

            .chart-container h5 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            .chart-container canvas {
                max-height: 250px !important;
            }

            /* Latest event cards */
            .latest-event-card {
                padding: 0.75rem;
            }

            .latest-event-card .event-remark {
                font-size: 0.8rem;
            }

            /* Warning cards */
            .warning-card {
                padding: 0.75rem;
            }

            .warning-badge {
                font-size: 0.65rem;
                padding: 0.2rem 0.5rem;
            }

            .warning-card .warning-title {
                font-size: 0.85rem;
            }

            /* Table adjustments */
            .table-sm th,
            .table-sm td {
                font-size: 0.7rem;
                padding: 0.25rem 0.3rem;
            }

            /* Update info */
            .update-info {
                font-size: 0.75rem;
                padding: 0.75rem;
            }

            /* Strait info section */
            .strait-badge {
                font-size: 0.75rem;
                padding: 0.3rem 0.75rem;
            }

            /* Reduce hover effects on touch */
            .stat-card:hover {
                transform: none;
            }

            .stat-card:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }

            /* Footer */
            footer {
                padding: 1.5rem 0 !important;
            }

            footer p {
                font-size: 0.85rem;
            }
        }

        /* Small phones */
        @media (max-width: 375px) {
            .page-header h1 {
                font-size: 1.25rem;
            }

            .stat-value, .msa-stat-value {
                font-size: 1.5rem;
            }

            .container {
                padding-left: 12px;
                padding-right: 12px;
            }

            #map {
                height: 250px !important;
            }
        }

        /* Landscape phone */
        @media (max-width: 767.98px) and (orientation: landscape) {
            .page-header {
                padding: 0.75rem 0;
            }

            .chart-container canvas {
                max-height: 200px !important;
            }

            #map {
                height: 250px !important;
            }
        }
    </style>
</head>
<body>

<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-custom">
    <div class="container">
        <a class="navbar-brand" href="index.html">PLA Dashboard</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="prediction.html">ML Prediction</a></li>
                <li class="nav-item"><a class="nav-link" href="weather.html">Airport Weather</a></li>
                <li class="nav-item active"><a class="nav-link" href="japan.html">Japan MOD</a></li>
                <li class="nav-item"><a class="nav-link" href="news.html">News</a></li>
                <li class="nav-item"><a class="nav-link" href="download.html">Download</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
            </ul>
        </div>
    </div>
</nav>

<!-- Page Header -->
<div class="page-header">
    <div class="container">
        <h1>Japan MOD Agent</h1>
        <p class="lead">Naval transit monitoring from Japan Joint Staff Office (統合幕僚監部)</p>
    </div>
</div>

<!-- Main Content -->
<div class="container">
    <!-- Update Info -->
    <div class="update-info">
        <strong>Data Source:</strong>
        <a href="https://www.mod.go.jp/js/press/index.html" target="_blank" class="source-link">Japan MOD Joint Staff Press</a> |
        <strong>Total Records:</strong> <span id="totalRecords">-</span> |
        <strong>Date Range:</strong> <span id="dateRange">-</span>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-label">Total Transit Events</div>
                <div class="stat-value" id="totalTransits">-</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-label">Yonaguni (與那國)</div>
                <div class="stat-value" id="yonaguniCount">-</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-label">Miyako (宮古)</div>
                <div class="stat-value" id="miyakoCount">-</div>
            </div>
        </div>
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="stat-card">
                <div class="stat-label">Joint Exercises</div>
                <div class="stat-value" id="jointExercise">-</div>
            </div>
        </div>
    </div>

    <!-- Latest Events Section -->
    <div class="card-custom">
        <h5>Latest Naval Transit Reports (最新艦艇動向)</h5>
        <div class="row" id="latestEventsContainer">
            <!-- Latest events will be populated by JavaScript -->
            <div class="col-12 text-center py-3">
                <span class="text-muted">Loading latest events...</span>
            </div>
        </div>
    </div>

    <!-- Map -->
    <div class="card-custom">
        <h5>Strait Locations, Transit Events & Military Exercise Zones</h5>
        <p class="text-muted mb-2">Use layer controls (top-right) to toggle Japan MOD straits and MSA military warning zones. Click areas for details.</p>
        <div id="map" style="height:550px;"></div>
    </div>

    <!-- MSA Military Exercise Warnings Section -->
    <div class="card-custom" style="border-top: 3px solid #e67e22;">
        <h5 style="color: #e67e22;">MSA Navigation Warnings - Military Exercises (航行警告)</h5>
        <p class="text-muted mb-2">
            Data Source: <a href="https://www.msa.gov.cn" target="_blank" class="source-link" style="color:#e67e22;">China MSA (中國海事局)</a> |
            Total Warnings: <span id="msaTotalWarnings">-</span> |
            Date Range: <span id="msaDateRange">-</span>
        </p>

        <!-- MSA Stats -->
        <div class="row mb-3">
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="stat-card">
                    <div class="stat-label">Military Exercises</div>
                    <div class="msa-stat-value" id="msaExerciseCount">-</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="stat-card">
                    <div class="stat-label">Live Fire Drills</div>
                    <div class="msa-stat-value" id="msaLiveFireCount">-</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="stat-card">
                    <div class="stat-label">Rocket Launches</div>
                    <div class="msa-stat-value" id="msaRocketCount">-</div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-2">
                <div class="stat-card">
                    <div class="stat-label">With Coordinates</div>
                    <div class="msa-stat-value" id="msaCoordsCount">-</div>
                </div>
            </div>
        </div>

        <!-- Warning Cards -->
        <div class="row" id="msaWarningCards">
            <div class="col-12 text-center py-3">
                <span class="text-muted">Loading military exercise warnings...</span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row">
        <div class="col-lg-6">
            <div class="chart-container">
                <h5>Transit Events by Strait</h5>
                <canvas id="straitChart"></canvas>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="chart-container">
                <h5>Monthly Transit Trend</h5>
                <canvas id="trendChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="card-custom">
        <h5>Recent Transit Events (Latest 100)</h5>
        <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
            <table class="table table-striped table-hover table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>PLA Sorties</th>
                        <th>Yonaguni<br>與那國</th>
                        <th>Miyako<br>宮古</th>
                        <th>Osumi<br>大禹</th>
                        <th>Tsushima<br>對馬</th>
                        <th>Joint Ex<br>聯合演訓</th>
                        <th>Direction</th>
                        <th>Vessel Type</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody id="transitTableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Strait Information -->
    <div class="card-custom">
        <h5>Monitored Straits Information</h5>
        <div class="row">
            <div class="col-md-3">
                <h6><span class="strait-badge strait-yonaguni">與那國海峽</span></h6>
                <p>Yonaguni Strait - Between Yonaguni Island and Taiwan. Key chokepoint near Taiwan.</p>
            </div>
            <div class="col-md-3">
                <h6><span class="strait-badge strait-miyako">宮古海峽</span></h6>
                <p>Miyako Strait - Between Miyako and Okinawa. Major PLAN transit route to Pacific.</p>
            </div>
            <div class="col-md-3">
                <h6><span class="strait-badge strait-osumi">大隅海峽</span></h6>
                <p>Osumi Strait - Southern route between Kyushu and Osumi Islands.</p>
            </div>
            <div class="col-md-3">
                <h6><span class="strait-badge strait-tsushima">對馬海峽</span></h6>
                <p>Tsushima Strait - Korea Strait between Japan and Korean Peninsula.</p>
            </div>
        </div>
    </div>
</div>

<!-- Footer -->
<footer class="text-center py-4 mt-5" style="background-color: #343a40; color: white;">
    <div class="container">
        <p>PLA Military Data Analysis Dashboard</p>
        <p>
            <a href="https://github.com/s0914712" target="_blank" style="color: #c94b4b;">GitHub</a> |
            <a href="https://s0914712.github.io" target="_blank" style="color: #c94b4b;">Blog</a>
        </p>
    </div>
</footer>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
let transitData = [];
let msaWarningData = [];
let map = null;
let msaLayerGroup = null;
let straitLayerGroup = null;
const isMobile = window.innerWidth < 768;

// Strait coordinates
const straitCoords = {
    'yonaguni': { lat: 24.4500, lng: 122.9500, name: '與那國海峽 (Yonaguni)', color: '#e74c3c' },
    'miyako': { lat: 24.7800, lng: 125.3000, name: '宮古海峽 (Miyako)', color: '#3498db' },
    'osumi': { lat: 30.7500, lng: 130.6500, name: '大隅海峽 (Osumi)', color: '#2ecc71' },
    'tsushima': { lat: 34.2000, lng: 129.3000, name: '對馬海峽 (Tsushima)', color: '#9b59b6' }
};

let latestEventMarkers = [];

window.addEventListener('load', async function() {
    initMap();
    await Promise.all([loadTransitData(), loadMSAWarnings()]);
    updateStatistics();
    renderLatestEvents();
    renderCharts();
    renderTable();
    renderMSAWarnings();
});

function initMap() {
    map = L.map('map').setView([28, 122], isMobile ? 3 : 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    // Create layer groups
    straitLayerGroup = L.layerGroup().addTo(map);
    msaLayerGroup = L.layerGroup().addTo(map);

    // Add strait markers
    Object.entries(straitCoords).forEach(([key, strait]) => {
        const icon = L.divIcon({
            className: 'custom-marker',
            html: `<div style="
                background: ${strait.color};
                width: 15px;
                height: 15px;
                border-radius: 50%;
                border: 2px solid white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            "></div>`,
            iconSize: [15, 15],
            iconAnchor: [7, 7]
        });

        const marker = L.marker([strait.lat, strait.lng], { icon: icon });
        marker.bindPopup(`<strong>${strait.name}</strong>`);
        straitLayerGroup.addLayer(marker);
    });

    // Draw approximate strait lines
    const straitLines = [
        { coords: [[24.2, 122.5], [24.7, 123.3]], color: '#e74c3c', name: 'Yonaguni' },
        { coords: [[24.5, 124.8], [25.1, 125.8]], color: '#3498db', name: 'Miyako' },
        { coords: [[30.5, 130.2], [31.0, 131.0]], color: '#2ecc71', name: 'Osumi' },
        { coords: [[33.8, 128.8], [34.6, 129.8]], color: '#9b59b6', name: 'Tsushima' }
    ];

    straitLines.forEach(line => {
        const polyline = L.polyline(line.coords, {
            color: line.color,
            weight: 4,
            opacity: 0.7,
            dashArray: '10, 10'
        });
        straitLayerGroup.addLayer(polyline);
    });

    // Add layer control
    const overlays = {
        'Japan MOD Straits': straitLayerGroup,
        'MSA Military Warnings': msaLayerGroup
    };
    L.control.layers(null, overlays, { position: 'topright', collapsed: false }).addTo(map);

    // Add legend
    const legend = L.control({ position: 'bottomright' });
    legend.onAdd = function() {
        const div = L.DomUtil.create('div', 'legend');
        div.innerHTML = `
            <div style="background: white; padding: 10px; border-radius: 5px; font-size: 0.8rem;">
                <div style="font-weight:bold; margin-bottom:4px;">Straits</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#e74c3c;border-radius:50%;margin-right:5px;"></span>Yonaguni</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#3498db;border-radius:50%;margin-right:5px;"></span>Miyako</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#2ecc71;border-radius:50%;margin-right:5px;"></span>Osumi</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#9b59b6;border-radius:50%;margin-right:5px;"></span>Tsushima</div>
                <div style="font-weight:bold; margin-top:6px; margin-bottom:4px;">MSA Warnings</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#e74c3c;border-radius:2px;margin-right:5px;opacity:0.5;"></span>Military Exercise</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#e67e22;border-radius:2px;margin-right:5px;opacity:0.5;"></span>Live Fire</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#8e44ad;border-radius:2px;margin-right:5px;opacity:0.5;"></span>Rocket Launch</div>
                <div><span style="display:inline-block;width:12px;height:12px;background:#2980b9;border-radius:2px;margin-right:5px;opacity:0.5;"></span>Military Mission</div>
            </div>
        `;
        return div;
    };
    legend.addTo(map);
}

async function loadTransitData() {
    try {
        const response = await fetch('data/JapanandBattleship.csv');
        const text = await response.text();
        const cleanText = text.replace(/^\uFEFF/, '');

        const parsed = Papa.parse(cleanText, {
            header: true,
            skipEmptyLines: true
        });

        transitData = parsed.data;
        console.log('Loaded transit data:', transitData.length, 'records');
    } catch (error) {
        console.error('Error loading transit data:', error);
    }
}

function hasValue(val) {
    return val && val !== '' && val !== 'FALSE' && val !== '0' && val !== 'false';
}

function getStraitForEvent(row) {
    // Determine which strait the event occurred at
    if (hasValue(row['與那國'])) return 'yonaguni';
    if (hasValue(row['宮古'])) return 'miyako';
    if (hasValue(row['大禹'])) return 'osumi';
    if (hasValue(row['對馬'])) return 'tsushima';
    return null;
}

function renderLatestEvents() {
    const container = document.getElementById('latestEventsContainer');

    // Find latest 3 events with remarks (sorted by date descending)
    const eventsWithRemarks = transitData
        .filter(row => row.remark && row.remark.trim() !== '' && row.remark !== '-')
        .sort((a, b) => {
            const dateA = new Date(a.date?.replace(/\//g, '-') || '1970-01-01');
            const dateB = new Date(b.date?.replace(/\//g, '-') || '1970-01-01');
            return dateB - dateA;
        })
        .slice(0, 3);

    if (eventsWithRemarks.length === 0) {
        container.innerHTML = `
            <div class="col-12 text-center py-3">
                <span class="text-muted">No recent transit events with detailed reports</span>
            </div>
        `;
        return;
    }

    // Render event cards
    container.innerHTML = '';
    eventsWithRemarks.forEach((event, index) => {
        const straitKey = getStraitForEvent(event);
        const straitInfo = straitKey ? straitCoords[straitKey] : null;

        // Build strait badges
        let straitBadges = '';
        if (hasValue(event['與那國'])) straitBadges += '<span class="event-strait strait-yonaguni">與那國</span>';
        if (hasValue(event['宮古'])) straitBadges += '<span class="event-strait strait-miyako">宮古</span>';
        if (hasValue(event['大禹'])) straitBadges += '<span class="event-strait strait-osumi">大禹</span>';
        if (hasValue(event['對馬'])) straitBadges += '<span class="event-strait strait-tsushima">對馬</span>';

        const direction = hasValue(event['進']) ? '← 進入東海' : (hasValue(event['出']) ? '→ 出向太平洋' : '');

        const cardHtml = `
            <div class="col-md-4 mb-3">
                <div class="latest-event-card">
                    <div class="event-date">
                        <strong>${event.date || 'Unknown Date'}</strong>
                        ${direction ? `<span class="ml-2 badge badge-secondary">${direction}</span>` : ''}
                    </div>
                    <div class="mt-2">
                        ${straitBadges || '<span class="text-muted">No specific strait</span>'}
                    </div>
                    ${event['艦型'] && event['艦型'] !== '未提及' ? `<div class="mt-2"><small><strong>艦型:</strong> ${event['艦型']}</small></div>` : ''}
                    <div class="event-remark mt-2">
                        ${event.remark || 'No details available'}
                    </div>
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;

        // Add marker on map for this event
        if (straitInfo) {
            addEventMarker(event, straitInfo, index);
        }
    });
}

function addEventMarker(event, straitInfo, index) {
    // Offset slightly to prevent overlap
    const latOffset = (index - 1) * 0.3;
    const lngOffset = (index - 1) * 0.5;

    const icon = L.divIcon({
        className: 'custom-event-marker',
        html: `<div class="pulse-marker" style="
            background: linear-gradient(135deg, #c94b4b 0%, #4b134f 100%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        ">${index + 1}</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
    });

    const marker = L.marker(
        [straitInfo.lat + latOffset, straitInfo.lng + lngOffset],
        { icon: icon, zIndexOffset: 1000 }
    ).addTo(map);

    // Build strait badges for popup
    let straitBadges = '';
    if (hasValue(event['與那國'])) straitBadges += '<span class="badge" style="background:#e74c3c;color:white;">與那國</span> ';
    if (hasValue(event['宮古'])) straitBadges += '<span class="badge" style="background:#3498db;color:white;">宮古</span> ';
    if (hasValue(event['大禹'])) straitBadges += '<span class="badge" style="background:#2ecc71;color:white;">大禹</span> ';
    if (hasValue(event['對馬'])) straitBadges += '<span class="badge" style="background:#9b59b6;color:white;">對馬</span> ';

    const direction = hasValue(event['進']) ? '← 進入東海 (In)' : (hasValue(event['出']) ? '→ 出向太平洋 (Out)' : '');

    const popupContent = `
        <div class="event-popup">
            <h6>Latest Event #${index + 1}</h6>
            <div style="margin-bottom:8px;">
                <strong>Date:</strong> ${event.date || '-'}<br>
                ${direction ? `<strong>Direction:</strong> ${direction}<br>` : ''}
                <strong>Straits:</strong> ${straitBadges || '-'}
            </div>
            ${event['艦型'] && event['艦型'] !== '未提及' ? `<div style="margin-bottom:8px;"><strong>艦型 (Vessel Type):</strong><br><small>${event['艦型']}</small></div>` : ''}
            <div style="background:#f8f9fa;padding:8px;border-radius:5px;font-size:0.85rem;line-height:1.5;">
                <strong>Report:</strong><br>
                ${event.remark || 'No details available'}
            </div>
        </div>
    `;

    marker.bindPopup(popupContent, { maxWidth: 350 });
    latestEventMarkers.push(marker);
}

function updateStatistics() {
    document.getElementById('totalRecords').textContent = transitData.length.toLocaleString();

    // Date range
    const dates = transitData.filter(r => r.date).map(r => r.date).sort();
    if (dates.length > 0) {
        document.getElementById('dateRange').textContent = `${dates[0]} - ${dates[dates.length - 1]}`;
    }

    // Count transits
    let yonaguni = 0, miyako = 0, osumi = 0, tsushima = 0, jointEx = 0;

    transitData.forEach(row => {
        if (hasValue(row['與那國'])) yonaguni++;
        if (hasValue(row['宮古'])) miyako++;
        if (hasValue(row['大禹'])) osumi++;
        if (hasValue(row['對馬'])) tsushima++;
        if (hasValue(row['聯合演訓'])) jointEx++;
    });

    document.getElementById('totalTransits').textContent = (yonaguni + miyako + osumi + tsushima).toLocaleString();
    document.getElementById('yonaguniCount').textContent = yonaguni;
    document.getElementById('miyakoCount').textContent = miyako;
    document.getElementById('jointExercise').textContent = jointEx;
}

function renderCharts() {
    // Strait distribution chart
    let yonaguni = 0, miyako = 0, osumi = 0, tsushima = 0;

    transitData.forEach(row => {
        if (hasValue(row['與那國'])) yonaguni++;
        if (hasValue(row['宮古'])) miyako++;
        if (hasValue(row['大禹'])) osumi++;
        if (hasValue(row['對馬'])) tsushima++;
    });

    new Chart(document.getElementById('straitChart'), {
        type: 'doughnut',
        data: {
            labels: isMobile
                ? ['Yonaguni', 'Miyako', 'Osumi', 'Tsushima']
                : ['Yonaguni (與那國)', 'Miyako (宮古)', 'Osumi (大禹)', 'Tsushima (對馬)'],
            datasets: [{
                data: [yonaguni, miyako, osumi, tsushima],
                backgroundColor: ['#e74c3c', '#3498db', '#2ecc71', '#9b59b6']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: !isMobile,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        boxWidth: isMobile ? 10 : 40,
                        font: { size: isMobile ? 10 : 12 },
                        padding: isMobile ? 8 : 10
                    }
                }
            }
        }
    });

    // Monthly trend chart
    const monthlyData = {};
    transitData.forEach(row => {
        if (!row.date) return;
        const date = new Date(row.date);
        if (isNaN(date)) return;
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;

        if (!monthlyData[monthKey]) {
            monthlyData[monthKey] = { total: 0, sorties: 0 };
        }

        if (hasValue(row['與那國']) || hasValue(row['宮古']) || hasValue(row['大禹']) || hasValue(row['對馬'])) {
            monthlyData[monthKey].total++;
        }
        if (row.pla_aircraft_sorties) {
            monthlyData[monthKey].sorties += parseFloat(row.pla_aircraft_sorties) || 0;
        }
    });

    // Get last 24 months
    const months = Object.keys(monthlyData).sort().slice(-24);
    const transitCounts = months.map(m => monthlyData[m].total);

    new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
            labels: months,
            datasets: [{
                label: 'Transit Events',
                data: transitCounts,
                borderColor: '#c94b4b',
                backgroundColor: 'rgba(201, 75, 75, 0.1)',
                borderWidth: isMobile ? 1.5 : 2,
                fill: true,
                tension: 0.4,
                pointRadius: isMobile ? 1 : 3,
                pointHitRadius: isMobile ? 15 : 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: !isMobile,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                x: {
                    ticks: {
                        maxTicksLimit: isMobile ? 6 : 12,
                        maxRotation: isMobile ? 60 : 45,
                        font: { size: isMobile ? 9 : 12 }
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: { font: { size: isMobile ? 9 : 12 } }
                }
            }
        }
    });
}

function renderTable() {
    const tbody = document.getElementById('transitTableBody');
    tbody.innerHTML = '';

    // Get latest 100 records
    const recentData = transitData.slice(-100).reverse();

    recentData.forEach(row => {
        const direction = hasValue(row['進']) ? '進 (In)' : (hasValue(row['出']) ? '出 (Out)' : '-');
        const dirClass = hasValue(row['進']) ? 'transit-in' : (hasValue(row['出']) ? 'transit-out' : '');

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.date || '-'}</td>
            <td><strong>${row.pla_aircraft_sorties || '-'}</strong></td>
            <td>${hasValue(row['與那國']) ? '✅' : '-'}</td>
            <td>${hasValue(row['宮古']) ? '✅' : '-'}</td>
            <td>${hasValue(row['大禹']) ? '✅' : '-'}</td>
            <td>${hasValue(row['對馬']) ? '✅' : '-'}</td>
            <td>${hasValue(row['聯合演訓']) ? '✅' : '-'}</td>
            <td class="${dirClass}">${direction}</td>
            <td><small>${row['艦型'] || '-'}</small></td>
            <td><small>${row['備考'] || row['remark'] || '-'}</small></td>
        `;
        tbody.appendChild(tr);
    });
}

// ========== MSA Military Exercise Warnings ==========

async function loadMSAWarnings() {
    try {
        const response = await fetch('data/navigation_warnings/military_exercises.csv');
        const text = await response.text();
        const cleanText = text.replace(/^\uFEFF/, '');

        const parsed = Papa.parse(cleanText, {
            header: true,
            skipEmptyLines: true
        });

        msaWarningData = parsed.data.map(row => {
            // Client-side fallback: extract missing coords/time from content_preview
            let coords = parseCoordinatesFromCSV(row.coordinates);
            let timePeriods = row.time_periods || '';
            const content = row.content_preview || '';

            // If coordinates are missing, try parsing from content_preview
            if (coords.length === 0 && content) {
                coords = extractCoordsFromContent(content);
            }

            // If time_periods missing, try parsing from content_preview
            if (!timePeriods && content) {
                timePeriods = extractTimeFromContent(content);
            }

            return {
                ...row,
                parsedCoords: coords,
                parsedTime: timePeriods,
                warningType: classifyWarningType(row.title, content)
            };
        });

        console.log('Loaded MSA warnings:', msaWarningData.length, 'records');
    } catch (error) {
        console.error('Error loading MSA warnings:', error);
    }
}

function parseCoordinatesFromCSV(coordStr) {
    if (!coordStr || coordStr.trim() === '') return [];
    return coordStr.split(';').map(pair => {
        const parts = pair.trim().split(',');
        if (parts.length === 2) {
            const lat = parseFloat(parts[0]);
            const lon = parseFloat(parts[1]);
            if (!isNaN(lat) && !isNaN(lon)) return { lat, lon };
        }
        return null;
    }).filter(Boolean);
}

function extractCoordsFromContent(text) {
    const coords = [];
    const seen = new Set();

    // Format: 31-21.60N/121-36.63E or 38-31.3N 121-33.2E
    const pattern1 = /(\d{1,2})-(\d{1,2}(?:\.\d+)?)\s*([NS])\s*[\/\s]\s*(\d{1,3})-(\d{1,2}(?:\.\d+)?)\s*([EW])/g;
    let match;
    while ((match = pattern1.exec(text)) !== null) {
        let lat = parseFloat(match[1]) + parseFloat(match[2]) / 60;
        let lon = parseFloat(match[4]) + parseFloat(match[5]) / 60;
        if (match[3] === 'S') lat = -lat;
        if (match[6] === 'W') lon = -lon;
        const key = lat.toFixed(4) + ',' + lon.toFixed(4);
        if (!seen.has(key)) {
            seen.add(key);
            coords.push({ lat: Math.round(lat * 10000) / 10000, lon: Math.round(lon * 10000) / 10000 });
        }
    }

    // Format: 38.5N 121.5E
    const pattern2 = /(\d{1,2}(?:\.\d+)?)\s*([NS])\s*(\d{1,3}(?:\.\d+)?)\s*([EW])/g;
    while ((match = pattern2.exec(text)) !== null) {
        let lat = parseFloat(match[1]);
        let lon = parseFloat(match[3]);
        if (match[2] === 'S') lat = -lat;
        if (match[4] === 'W') lon = -lon;
        const key = lat.toFixed(4) + ',' + lon.toFixed(4);
        if (!seen.has(key)) {
            seen.add(key);
            coords.push({ lat, lon });
        }
    }

    return coords;
}

function extractTimeFromContent(text) {
    // Pattern: 自X月X日至X月X日，每日XXXX时至XXXX时
    let m = text.match(/自(\d{1,2}月\d{1,2}日)至(\d{1,2}月?\d{1,2}日)[，,]\s*每日(\d{4}时至\d{4}时)/);
    if (m) return m[0];

    // Pattern: X月X日XXXX时至XXXX时
    m = text.match(/\d{1,2}月\d{1,2}日\d{4}时至\d{4}时/);
    if (m) return m[0];

    // Pattern: 自X月X日X时至X月X日X时
    m = text.match(/自?\d{1,2}月\d{1,2}日\d{1,4}时至\d{1,2}月?\d{1,2}日?\d{1,4}时/);
    if (m) return m[0];

    // Pattern: XXXX年X月X日XXXX时至XXXX时
    m = text.match(/\d{4}年\d{1,2}月\d{1,2}日\d{4}时至\d{4}时/);
    if (m) return m[0];

    // English: FROM DDHHMM UTC TO DDHHMM UTC
    m = text.match(/FROM\s+\d{6}\s*UTC\s+TO\s+\d{6}\s*UTC/i);
    if (m) return m[0];

    return '';
}

function classifyWarningType(title, content) {
    const text = (title + ' ' + content).toLowerCase();
    if (/火箭发射|火箭残骸|rocket/.test(text)) return 'rocket';
    if (/实弹|射击|live.?fire|gunnery|射擊/.test(text)) return 'livefire';
    if (/军事任务|military.?mission|軍事任務/.test(text)) return 'mission';
    if (/演习|exercise|演練|演訓|军演|軍演/.test(text)) return 'exercise';
    return 'other';
}

function getWarningColor(type) {
    const colors = {
        exercise: '#e74c3c',
        livefire: '#e67e22',
        rocket: '#8e44ad',
        mission: '#2980b9',
        other: '#7f8c8d'
    };
    return colors[type] || colors.other;
}

function getWarningLabel(type) {
    const labels = {
        exercise: 'Military Exercise',
        livefire: 'Live Fire',
        rocket: 'Rocket Launch',
        mission: 'Military Mission',
        other: 'Navigation Warning'
    };
    return labels[type] || labels.other;
}

function getWarningLabelCN(type) {
    const labels = {
        exercise: '军事演习',
        livefire: '实弹射击',
        rocket: '火箭发射',
        mission: '军事任务',
        other: '航行警告'
    };
    return labels[type] || labels.other;
}

function renderMSAWarnings() {
    if (!msaWarningData || msaWarningData.length === 0) return;

    // Update stats
    const types = { exercise: 0, livefire: 0, rocket: 0, mission: 0, other: 0 };
    let withCoords = 0;
    msaWarningData.forEach(w => {
        types[w.warningType] = (types[w.warningType] || 0) + 1;
        if (w.parsedCoords.length > 0) withCoords++;
    });

    document.getElementById('msaTotalWarnings').textContent = msaWarningData.length;
    document.getElementById('msaExerciseCount').textContent = types.exercise + types.mission;
    document.getElementById('msaLiveFireCount').textContent = types.livefire;
    document.getElementById('msaRocketCount').textContent = types.rocket;
    document.getElementById('msaCoordsCount').textContent = withCoords;

    const dates = msaWarningData.filter(w => w.publish_date).map(w => w.publish_date).sort();
    if (dates.length > 0) {
        document.getElementById('msaDateRange').textContent = `${dates[0]} ~ ${dates[dates.length - 1]}`;
    }

    // Render warning cards
    const container = document.getElementById('msaWarningCards');
    const sorted = [...msaWarningData].sort((a, b) => (b.publish_date || '').localeCompare(a.publish_date || ''));
    container.innerHTML = '';

    sorted.forEach((w, idx) => {
        const color = getWarningColor(w.warningType);
        const label = getWarningLabel(w.warningType);
        const labelCN = getWarningLabelCN(w.warningType);
        const hasCoords = w.parsedCoords.length > 0;

        // Extract clean content from content_preview
        const cleanContent = extractCleanContent(w.content_preview || '');

        const cardHtml = `
            <div class="col-md-6 col-lg-4 mb-3">
                <div class="warning-card" style="border-left-color: ${color};">
                    <div class="d-flex justify-content-between align-items-start">
                        <span class="warning-badge" style="background:${color};">${labelCN} ${label}</span>
                        <span class="warning-date">${w.publish_date || '-'}</span>
                    </div>
                    <div class="warning-title mt-2">${w.title || '-'}</div>
                    <div class="warning-channel">${w.channel || '-'}</div>
                    ${w.parsedTime ? `<div class="mt-1"><small><strong>Time:</strong> ${w.parsedTime}</small></div>` : ''}
                    ${hasCoords ? `<div class="mt-1"><small><strong>Coords:</strong> ${w.parsedCoords.length} points</small></div>` : '<div class="mt-1"><small class="text-danger">No coordinates</small></div>'}
                    <div class="mt-1"><small class="text-muted">${cleanContent.substring(0, 120)}${cleanContent.length > 120 ? '...' : ''}</small></div>
                    ${w.url ? `<div class="mt-1"><a href="${w.url}" target="_blank" class="source-link" style="font-size:0.75rem;color:${color};">View Source</a></div>` : ''}
                </div>
            </div>
        `;
        container.innerHTML += cardHtml;

        // Add to map
        if (hasCoords) {
            addMSAWarningToMap(w, idx);
        }
    });
}

function extractCleanContent(text) {
    // Remove common MSA website boilerplate
    let clean = text
        .replace(/English\s+x\s+中国海事公众号.*?航行警告\s+\S+海事局\s*/s, '')
        .replace(/发布时间：\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}\s+\[字体：\s*大\s*中\s*小\s*\]\s*分享到：\s*/, '')
        .replace(/\s+/g, ' ')
        .trim();

    // Try to extract from the warning code onward
    const codeMatch = clean.match(/([A-Za-z\u4e00-\u9fa5]航警?\d+\/\d+|[A-Z]{2,3}\d+\/\d+)/);
    if (codeMatch) {
        const idx = clean.indexOf(codeMatch[0]);
        if (idx >= 0) clean = clean.substring(idx);
    }

    return clean;
}

function addMSAWarningToMap(warning, index) {
    const coords = warning.parsedCoords;
    const color = getWarningColor(warning.warningType);
    const label = getWarningLabel(warning.warningType);
    const labelCN = getWarningLabelCN(warning.warningType);

    // Build popup
    const cleanContent = extractCleanContent(warning.content_preview || '');
    const popupHtml = `
        <div style="min-width:250px;max-width:350px;">
            <h6 style="color:${color};margin-bottom:6px;">${labelCN} ${label}</h6>
            <div style="margin-bottom:6px;">
                <strong>Title:</strong> ${warning.title || '-'}<br>
                <strong>Date:</strong> ${warning.publish_date || '-'}<br>
                <strong>Channel:</strong> ${warning.channel || '-'}<br>
                ${warning.parsedTime ? `<strong>Time:</strong> ${warning.parsedTime}<br>` : ''}
                <strong>Coords:</strong> ${coords.length} points
            </div>
            <div style="background:#f8f9fa;padding:8px;border-radius:5px;font-size:0.8rem;max-height:150px;overflow-y:auto;">
                ${cleanContent.substring(0, 300)}${cleanContent.length > 300 ? '...' : ''}
            </div>
            ${warning.url ? `<div style="margin-top:6px;"><a href="${warning.url}" target="_blank" style="color:${color};font-size:0.8rem;">View on MSA</a></div>` : ''}
        </div>
    `;

    if (coords.length === 1) {
        // Single point: draw a circle (e.g., rocket launch with radius)
        const circle = L.circle([coords[0].lat, coords[0].lon], {
            radius: 11112, // ~6 nautical miles in meters
            color: color,
            fillColor: color,
            fillOpacity: 0.2,
            weight: 2,
            dashArray: '5, 5'
        });
        circle.bindPopup(popupHtml, { maxWidth: 350 });
        msaLayerGroup.addLayer(circle);

        // Add center marker
        const icon = L.divIcon({
            className: 'msa-marker',
            html: `<div style="
                background:${color};
                width:10px;height:10px;
                border-radius:50%;
                border:2px solid white;
                box-shadow:0 1px 4px rgba(0,0,0,0.4);
            "></div>`,
            iconSize: [10, 10],
            iconAnchor: [5, 5]
        });
        const marker = L.marker([coords[0].lat, coords[0].lon], { icon: icon });
        marker.bindPopup(popupHtml, { maxWidth: 350 });
        msaLayerGroup.addLayer(marker);
    } else if (coords.length >= 3) {
        // Multiple points: draw a polygon
        const latlngs = coords.map(c => [c.lat, c.lon]);
        const polygon = L.polygon(latlngs, {
            color: color,
            fillColor: color,
            fillOpacity: 0.2,
            weight: 2
        });
        polygon.bindPopup(popupHtml, { maxWidth: 350 });
        msaLayerGroup.addLayer(polygon);
    } else if (coords.length === 2) {
        // Two points: draw a rectangle bounding box
        const bounds = L.latLngBounds(coords.map(c => [c.lat, c.lon]));
        const rect = L.rectangle(bounds, {
            color: color,
            fillColor: color,
            fillOpacity: 0.2,
            weight: 2
        });
        rect.bindPopup(popupHtml, { maxWidth: 350 });
        msaLayerGroup.addLayer(rect);
    }
}
</script>

</body>
</html>
